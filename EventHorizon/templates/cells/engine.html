{% extends 'admin/base_site.html' %}
{% load i18n %}


{% block content %}

<script src="/site_media/js/jquery-1.2.6.js"></script>

<script language="JavaScript">

/*
var layers = [
	[{"pk": 1, "model": "cells.basecell", "fields": {"core": "Modells twittersphere", "layer": 0, "container": null, "name": "Twittersphere", "last_processing_cycle": null, "created_at": "2009-06-03 15:33:11", "last_update": "2009-06-03 15:33:11", "child_count": 0, "y": 200, "x": 200, "last_processing_time": "2009-06-03 15:33:11", "external_id": ""}}],
	[{"pk": 3, "model": "cells.basecell", "fields": {"core": "Agent representing Udi's world", "layer": 1, "container": 1, "name": "Udi's agent", "last_processing_cycle": null, "created_at": "2009-06-03 15:35:32", "last_update": "2009-06-03 15:35:32", "child_count": 0, "y": 100, "x": 100, "last_processing_time": "2009-06-03 15:35:32", "external_id": ""}}],
	[{"pk": 2, "model": "cells.basecell", "fields": {"core": "Udi h Bauman", "layer": 2, "container": 3, "name": "Udi", "last_processing_cycle": null, "created_at": "2009-06-03 15:35:17", "last_update": "2009-06-03 15:35:51", "child_count": 0, "y": 100, "x": 100, "last_processing_time": "2009-06-03 15:35:51", "external_id": ""}}, {"pk": 4, "model": "cells.basecell", "fields": {"core": "Yay! great review of my company beeTV in @techcrunch!", "layer": 2, "container": 3, "name": "Yay! great review of my company beeTV in @techcrunch!", "last_processing_cycle": null, "created_at": "2009-06-03 15:36:58", "last_update": "2009-06-03 15:36:58", "child_count": 0, "y": 150, "x": 150, "last_processing_time": "2009-06-03 15:36:58", "external_id": ""}}, {"pk": 5, "model": "cells.basecell", "fields": {"core": "Thanks @nivs, @alisohani!", "layer": 2, "container": 3, "name": "Thanks @nivs, @alisohani!", "last_processing_cycle": null, "created_at": "2009-06-03 15:37:34", "last_update": "2009-06-03 15:37:34", "child_count": 0, "y": 150, "x": 170, "last_processing_time": "2009-06-03 15:37:34", "external_id": ""}}],
	[]
];
*/

var layers = [[], [], [], []];
//var layers = [[{"pk": 1, "model": "cells.basecell", "fields": {"core": "Engine instance modeling the world reflected by Twitter streams", "layer": 0, "container": null, "name": "Twittersphere", "last_processing_cycle": 6293, "created_at": "2009-06-09 01:43:02", "last_update": "2009-06-30 06:56:50", "location": "(layer-0, 500, 500)", "y": 500, "x": 500, "last_processing_time": "2009-06-30 06:56:50", "external_id": "", "child_count": 0}}],[{"pk": 3, "model": "cells.basecell", "fields": {"core": "Agent for Udi h Bauman", "layer": 1, "container": 1, "name": "Udi's agent", "last_processing_cycle": 6320, "created_at": "2009-06-09 01:46:34", "last_update": "2009-06-30 17:07:56", "location": "(layer-1, 400, 600)", "y": 600, "x": 400, "last_processing_time": "2009-06-30 17:07:56", "external_id": "", "child_count": 0}}, {"pk": 7, "model": "cells.basecell", "fields": {"core": "Agent representing Inna Bauman", "layer": 1, "container": 1, "name": "Inna's Agent", "last_processing_cycle": 6320, "created_at": "2009-06-23 09:40:19", "last_update": "2009-06-30 17:07:56", "location": "(layer-1, 429, 529)", "y": 529, "x": 429, "last_processing_time": "2009-06-30 17:07:56", "external_id": "", "child_count": 0}}],[{"pk": 2, "model": "cells.basecell", "fields": {"core": "Representing the human Udi h Bauman", "layer": 2, "container": 3, "name": "Udi h Bauman", "last_processing_cycle": 6320, "created_at": "2009-06-09 01:46:22", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 350, 200)", "y": 200, "x": 350, "last_processing_time": "2009-06-30 17:07:56", "external_id": "", "child_count": 0}}, {"pk": 4, "model": "cells.basecell", "fields": {"core": "Yay! great review of my company beeTV in @techcrunch!", "layer": 2, "container": 3, "name": "Yay! great review of my company beeTV in @techcrunch!", "last_processing_cycle": 6320, "created_at": "2009-06-09 01:47:59", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 778, 558)", "y": 558, "x": 778, "last_processing_time": "2009-06-30 17:07:56", "external_id": "85848764", "child_count": 0}}, {"pk": 5, "model": "cells.basecell", "fields": {"core": "Thanks @nivs, @alisohani!", "layer": 2, "container": 3, "name": "Thanks @nivs, @alisohani!", "last_processing_cycle": 6320, "created_at": "2009-06-09 01:48:49", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 928, 538)", "y": 538, "x": 928, "last_processing_time": "2009-06-30 17:07:56", "external_id": "", "child_count": 0}}, {"pk": 6, "model": "cells.basecell", "fields": {"core": "Representing Inna Bauman", "layer": 2, "container": null, "name": "Inna", "last_processing_cycle": null, "created_at": "2009-06-23 09:38:42", "last_update": "2009-06-23 09:38:42", "location": "(layer-2, 180, 230)", "y": 230, "x": 180, "last_processing_time": "2009-06-23 09:38:42", "external_id": "987979", "child_count": 0}}, {"pk": 8, "model": "cells.basecell", "fields": {"core": "Watching Brilliant Noise - short film using NASA images of the Sun", "layer": 2, "container": 3, "name": "Watching Brilliant Noise - short film using NASA images of the Sun", "last_processing_cycle": 6320, "created_at": "2009-06-23 09:43:29", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 801, 260)", "y": 260, "x": 801, "last_processing_time": "2009-06-30 17:07:56", "external_id": "23131322", "child_count": 0}}, {"pk": 9, "model": "cells.basecell", "fields": {"core": "John Hodgins testing Obama's nerdiness", "layer": 2, "container": 3, "name": "John Hodgins testing Obama's nerdiness", "last_processing_cycle": 6320, "created_at": "2009-06-23 09:46:11", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 501, 468)", "y": 468, "x": 501, "last_processing_time": "2009-06-30 17:07:56", "external_id": "78577987", "child_count": 0}}, {"pk": 10, "model": "cells.basecell", "fields": {"core": "Don't understand why people sleep at night", "layer": 2, "container": 7, "name": "Don't understand why people sleep at night", "last_processing_cycle": 6320, "created_at": "2009-06-23 09:47:17", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 690, 782)", "y": 782, "x": 690, "last_processing_time": "2009-06-30 17:07:56", "external_id": "189128128", "child_count": 0}}, {"pk": 11, "model": "cells.basecell", "fields": {"core": "<h3>Summary for [Agent] Inna</h3><li>[Agent] Udi h Bauman twitted 2 times", "layer": 2, "container": 3, "name": "Inna's summary for Tue Jun 23 00:00:00 2009", "last_processing_cycle": 6320, "created_at": "2009-06-23 09:50:02", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 356, 658)", "y": 658, "x": 356, "last_processing_time": "2009-06-30 17:07:56", "external_id": null, "child_count": 0}}, {"pk": 12, "model": "cells.basecell", "fields": {"core": "<h3>Summary for [Agent] Udi h Bauman</h3><li>[Agent] Inna twitted 1 times", "layer": 2, "container": 7, "name": "Udi h Bauman's summary for Tue Jun 23 00:00:00 2009", "last_processing_cycle": 6320, "created_at": "2009-06-23 20:36:15", "last_update": "2009-06-30 17:07:56", "location": "(layer-2, 863, 574)", "y": 574, "x": 863, "last_processing_time": "2009-06-30 17:07:56", "external_id": null, "child_count": 0}}],[]];

var currentLayer = 2;
var cells_by_location = [{}, {}, {}, {}];


function map_cells_by_location() {
	cells_by_location = [{}, {}, {}, {}];
	for (l = 0; l < cells_by_location.length; l++) {
		map = cells_by_location[l];
		for (i = 0; i < layers[l].length; i++) {
			cell = layers[l][i];
			x = cell.fields.x;
			y = cell.fields.y;
			x = Math.round(x / 10);
			y = Math.round(y / 10);
			map[x] = {};
			map[x][y] = cell;
		}
	}
}

function get_cell_by_location(x, y) {
	x = Math.round(x / 10);
	y = Math.round(y / 10);
	if (cells_by_location[currentLayer][x])
		if (cells_by_location[currentLayer][x][y])
			return cells_by_location[currentLayer][x][y];
	return null;
}


function refresh() {
	var url = 'http://{{ domain }}/cells/';
	window.status = "Querying " + url + " for updates...";
	jQuery.get(
		url, 
		{},
		function(data, textStatus) {
			try {
				window.status = "Received new updates...";
				layers = eval(data);
				//alert(data);
				//alert(data.length);
				//alert("layers = " + layers);
				draw_layer(currentLayer);
				map_cells_by_location();
				window.status = "Done";
			} catch (e) {
				window.status = e;
			}
		},
		function(data, textStatus) {
			window.status = 'Failed to query for updates: ' + textStatus;
		}, 
		"json");
}


function periodic_refresh() {
	try {
		refresh();
	} catch (e) {
		//console.log(e);
	}
	setTimeout('periodic_refresh()', 5000);
}


function draw_layer(l) {
	currentLayer = l;
	var layer = layers[l];
	//alert(layer);
	var canvas = document.getElementById('engine');
	if (canvas.getContext){
	  var ctx = canvas.getContext('2d');
		ctx.clearRect(0, 0, 1000, 1000);
		for (i = 0; i < layer.length; i++) {
			cell = layer[i];
	
	        ctx.beginPath();
	        if (cell.fields.core.split(' ')[0] == "Representing")
	        	ctx.fillStyle = "rgb(50,200,200)";
	        else
	        	ctx.fillStyle = "rgb(50,10,100)";	        
	        ctx.fillRect (cell.fields.x, cell.fields.y, 5, 5);
			ctx.closePath();
		}
	}
}


function highlight(text) {
	var label = document.getElementById("highlighted_cell");
	if (label) {
		label.innerHTML = text;
	}
}


function handle( e )
{
	var canvas = document.getElementById('engine');
	if (canvas.getContext){
		var ctx = canvas.getContext('2d');
		// todo find coordinates properly
		var x = e.pageX - 180, y = e.pageY - 142;
		//ctx.fillRect( x, y, 10, 10 );
		if (get_cell_by_location(x, y)) {
			highlight(get_cell_by_location(x, y).fields.core);
		}
		else {
			highlight("<img src='/media/img/admin/selector-search.gif'/>");
		}
		window.status = "(" + x + "," + y + ")";
	}
}


window.onload = function() {
	var canvas = document.getElementById('engine');
	canvas.onmousemove = handle;
	periodic_refresh();
	//alert(layers);
	//alert(layers.length);
}

</script>


<table border="0" width="80%">
    <tr>
        <td width="30%" valign="top" align="left">
            <form>
                <p>
                    <input type="text" width="60" name="query">
                    <input type="button" value="Filter">
                </p>
            </form>
        </td>
        <td>
            <h3>{% trans 'Currently' %} {{ nagents }} {% trans 'agents are serving' %}</h3>
        </td>
        <td></td>
    </tr>
    <tr>
        <td width="30%" valign="top" align="right">
            <br/>
            <a href="javascript:draw_layer(0)" style="background-color: #D5D5D5">Layer 0</a><br/>
            <br/>
            <a href="javascript:draw_layer(1)" style="background-color: #D5D5D5">Layer 1</a><br/>
            <br/>
            <a href="javascript:draw_layer(2)" style="background-color: #D5D5D5">Layer 2</a><br/>
            <br/>
            <a href="javascript:draw_layer(3)" style="background-color: #D5D5D5">Layer 3</a><br/>
        </td>
        <td>
            <canvas id="engine" width="1000" height="1000" style="background-color: #F5F5F5">
				Please upgrade your browser to an HTML 5 compliant browser, such as Mozilla Firefox 3 or Safari 4.
            </canvas>
        </td>
        <td id="highlighted_cell" style="background-color: lightgrey">
        	<img src='/media/img/admin/selector-search.gif'/>
    	</td>
    </tr>
</table>


{% endblock content %}